<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Java Class Studio - Interactive OOP Learning Tool</title>
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --bg-dark: #0f172a;
        --panel-bg: #1e293b;
        --accent: #38bdf8;
        --accent-glow: rgba(56, 189, 248, 0.4);
        --code-text: #e2e8f0;
        --keyword: #c084fc;
        --string: #4ade80;
        --type: #facc15;
        --object-bg: #334155;
        --danger: #ef4444;
        --success: #22c55e;
      }

      * {
        box-sizing: border-box;
      }

      body {
        background-color: #020617;
        color: white;
        font-family: "Inter", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        overflow-x: hidden;
      }

      h1 {
        background: linear-gradient(to right, #38bdf8, #a855f7);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 10px;
        font-weight: 800;
      }

      .subtitle {
        color: #94a3b8;
        margin-bottom: 30px;
      }

      /* MAIN LAYOUT */
      .factory-container {
        display: grid;
        grid-template-columns: 400px 1fr 400px;
        gap: 30px;
        width: 100%;
        max-width: 1500px;
        align-items: start;
      }

      /* PANELS */
      .panel {
        background: var(--panel-bg);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid #334155;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        min-height: 600px;
        display: flex;
        flex-direction: column;
      }

      .panel-header {
        font-family: "JetBrains Mono", monospace;
        color: var(--accent);
        font-size: 1.1rem;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border-bottom: 1px solid #334155;
        padding-bottom: 15px;
      }

      /* BLUEPRINT STYLES */
      .blueprint-content {
        font-family: "JetBrains Mono", monospace;
        color: #94a3b8;
        line-height: 1.5;
        font-size: 0.85rem;
        background: #0f172a;
        padding: 15px;
        border-radius: 8px;
        border: 1px dashed var(--accent);
        flex-grow: 1;
        overflow-y: auto;
        max-height: 500px;
      }

      .hl-key {
        color: var(--keyword);
      }
      .hl-type {
        color: var(--accent);
      }
      .hl-var {
        color: var(--type);
      }
      .hl-str {
        color: var(--string);
      }
      .hl-comment {
        color: #64748b;
        font-style: italic;
      }

      /* DESIGNER CONTROLS (Left Panel Bottom) */
      .designer-controls {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #334155;
      }

      .add-field-row {
        display: grid;
        grid-template-columns: 2fr 1.5fr 40px;
        gap: 8px;
        margin-top: 10px;
      }

      .mini-btn {
        background: var(--success);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mini-btn:hover {
        filter: brightness(1.1);
      }
      .mini-btn.danger {
        background: var(--danger);
      }
      .mini-btn.secondary {
        background: #475569;
      }

      /* MIDDLE PANEL (JVM) */
      .controls {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 600px;
        padding: 20px;
      }

      .constructor-area {
        width: 100%;
        background: #0f172a;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #475569;
      }

      .input-group {
        margin-bottom: 15px;
        width: 100%;
      }

      label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        color: #cbd5e1;
        font-size: 0.85rem;
        font-family: "JetBrains Mono", monospace;
      }

      .type-badge {
        font-size: 0.7rem;
        color: var(--keyword);
        background: rgba(192, 132, 252, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #475569;
        background: #1e293b;
        color: white;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s;
      }

      input:focus,
      select:focus {
        border-color: var(--accent);
      }

      .btn-construct {
        background: linear-gradient(135deg, var(--accent), #8b5cf6);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 20px var(--accent-glow);
        transition: transform 0.1s, box-shadow 0.2s;
        font-family: "JetBrains Mono", monospace;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        width: 100%;
        justify-content: center;
      }

      .btn-construct:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 30px var(--accent-glow);
      }

      .btn-construct:active {
        transform: translateY(1px);
      }

      /* MEMORY HEAP (RIGHT) */
      .heap-grid {
        display: grid;
        grid-template-columns: 1fr; /* Stack them for better detail visibility */
        gap: 15px;
        overflow-y: auto;
        max-height: 520px;
        padding-right: 5px;
      }

      .object-card {
        background: var(--object-bg);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid #475569;
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
      }

      @keyframes popIn {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .card-icon {
        font-size: 2.5rem;
        width: 60px;
        text-align: center;
        color: var(--accent);
      }

      .card-details {
        flex-grow: 1;
        text-align: left;
      }

      .mem-address {
        font-size: 0.7rem;
        color: #64748b;
        font-family: monospace;
        margin-bottom: 5px;
        display: block;
      }

      .field-row {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8rem;
        color: #cbd5e1;
        margin-bottom: 2px;
        display: flex;
        gap: 8px;
      }

      .field-name {
        color: #94a3b8;
      }
      .field-val {
        color: var(--string);
        font-weight: bold;
      }

      /* ANIMATION BEAM */
      .construction-beam {
        position: fixed;
        pointer-events: none;
        z-index: 100;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 0 20px 5px white, 0 0 40px 10px var(--accent);
        display: none;
        mix-blend-mode: screen;
      }

      .explanation-box {
        margin-top: 30px;
        background: rgba(30, 41, 59, 0.5);
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid var(--accent);
        max-width: 1200px;
        width: 100%;
        line-height: 1.6;
        color: #cbd5e1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      /* Field management */
      .field-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background: rgba(15, 23, 42, 0.5);
        border-radius: 6px;
        margin-bottom: 6px;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.85rem;
      }

      .field-item-locked {
        opacity: 0.7;
      }

      .delete-btn {
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        padding: 4px 8px;
        font-size: 0.75rem;
        transition: filter 0.2s;
      }

      .delete-btn:hover {
        filter: brightness(1.2);
      }

      .delete-object-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        transition: all 0.2s;
        opacity: 0.7;
      }

      .delete-object-btn:hover {
        opacity: 1;
        transform: scale(1.1);
      }

      /* Statistics panel */
      .stats-panel {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 0.8rem;
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        display: block;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--accent);
        font-family: "JetBrains Mono", monospace;
      }

      .stat-label {
        color: #94a3b8;
        font-size: 0.7rem;
      }

      /* Method execution visualization */
      .method-panel {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
      }

      .method-btn {
        background: linear-gradient(135deg, #8b5cf6, #ec4899);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.85rem;
        margin-top: 8px;
        width: 100%;
        transition: transform 0.1s;
      }

      .method-btn:hover {
        transform: translateY(-1px);
      }

      .method-output {
        margin-top: 10px;
        padding: 10px;
        background: #0f172a;
        border-radius: 6px;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.75rem;
        color: var(--string);
        min-height: 30px;
        white-space: pre-wrap;
        line-height: 1.4;
      }

      /* Highlighting for object comparison */
      .object-card.highlight {
        border: 2px solid var(--accent);
        box-shadow: 0 0 20px var(--accent-glow);
      }

      /* Clear heap button */
      .clear-heap-btn {
        width: 100%;
        padding: 10px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 10px;
        transition: filter 0.2s;
        font-family: "Inter", sans-serif;
      }

      .clear-heap-btn:hover {
        filter: brightness(1.1);
      }

      /* Inheritance indicator */
      .extends-badge {
        display: inline-block;
        background: rgba(168, 85, 247, 0.2);
        color: var(--keyword);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        margin-left: 10px;
        border: 1px solid var(--keyword);
      }

      /* Static field indicator */
      .static-badge {
        background: rgba(250, 204, 21, 0.2);
        color: var(--type);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.65rem;
        margin-left: 5px;
      }

      /* Reference type indicator */
      .reference-indicator {
        position: absolute;
        bottom: 10px;
        right: 10px;
        font-size: 0.7rem;
        color: #64748b;
        font-style: italic;
      }

      /* Scrollbar styling */
      .heap-grid::-webkit-scrollbar,
      .blueprint-content::-webkit-scrollbar {
        width: 8px;
      }

      .heap-grid::-webkit-scrollbar-track,
      .blueprint-content::-webkit-scrollbar-track {
        background: #0f172a;
        border-radius: 4px;
      }

      .heap-grid::-webkit-scrollbar-thumb,
      .blueprint-content::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
      }

      .heap-grid::-webkit-scrollbar-thumb:hover,
      .blueprint-content::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }

      /* Mobile responsiveness */
      @media (max-width: 1200px) {
        .factory-container {
          grid-template-columns: 1fr;
          max-width: 600px;
        }

        .explanation-box {
          grid-template-columns: 1fr;
        }

        .controls {
          min-height: auto;
        }
      }

      /* Dropdown styling for Class Selector */
      .class-select {
        background: #0f172a;
        border: 1px solid var(--accent);
        color: white;
        padding: 5px 10px;
        border-radius: 6px;
        font-family: "Inter", sans-serif;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Java Class Designer & Factory</h1>
    <p class="subtitle">
      Design the Class (Left) &rarr; Build the Object (Middle) &rarr; Store in
      Memory (Right)
    </p>

    <div class="factory-container">
      <!-- LEFT: THE CLASS (BLUEPRINT) -->
      <div class="panel" id="blueprint-panel">
        <div class="panel-header">
          <span><i class="fa-solid fa-file-code"></i> Blueprint</span>
          <select
            id="classSelector"
            class="class-select"
            onchange="switchClass()"
          >
            <option value="Robot">Robot</option>
            <option value="Car">Car</option>
            <option value="Cat">Cat</option>
            <option value="Planet">Planet</option>
            <option value="Dog">Dog (extends Animal)</option>
            <option value="Student">Student</option>
          </select>
        </div>

        <div id="codeDisplay" class="blueprint-content">
          <!-- Code injected by JS -->
        </div>

        <div class="designer-controls">
          <label style="color: var(--accent)">
            <i class="fa-solid fa-pen-ruler"></i> Design: Add New Field</label
          >
          <div id="fieldList" style="margin-bottom: 10px;">
            <!-- Dynamic field list with delete buttons -->
          </div>
          <div class="add-field-row">
            <input
              type="text"
              id="newFieldName"
              placeholder="Field Name (e.g. speed)"
            />
            <select id="newFieldType">
              <option value="String">String</option>
              <option value="int">int</option>
              <option value="boolean">boolean</option>
              <option value="double">double</option>
            </select>
            <button class="mini-btn" onclick="addField()" title="Add Field">
              <i class="fa-solid fa-plus"></i>
            </button>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button class="mini-btn secondary" onclick="addStaticField()" title="Add Static Field" style="flex: 1; font-size: 0.75rem; padding: 10px 8px;">
              <i class="fa-solid fa-layer-group"></i> Static
            </button>
            <button class="mini-btn danger" onclick="resetClass()" title="Reset to Template" style="flex: 1; font-size: 0.75rem; padding: 10px 8px;">
              <i class="fa-solid fa-rotate-left"></i> Reset
            </button>
          </div>
        </div>
      </div>

      <!-- MIDDLE: CONTROLS (JVM) -->
      <div class="controls">
        <div style="margin-bottom: 20px; text-align: center">
          <h3 style="margin: 0; color: var(--accent)">Constructor Call</h3>
          <span style="color: #64748b; font-size: 0.9rem"
            >Fill in the arguments</span
          >
        </div>

        <div class="constructor-area">
          <div id="dynamicInputs">
            <!-- Inputs injected by JS -->
          </div>

          <button class="btn-construct" onclick="createObject()">
            <i class="fa-solid fa-cube"></i>
            <span id="btnText">new Robot();</span>
          </button>
        </div>

        <div
          id="code-preview"
          style="
            margin-top: 20px;
            font-family: 'JetBrains Mono';
            color: #64748b;
            font-size: 0.85rem;
            text-align: center;
          "
        >
          Robot r = new Robot(...);
        </div>

        <!-- Method Demonstration Panel -->
        <div class="method-panel" id="methodPanel" style="display: none;">
          <div style="color: var(--accent); font-size: 0.9rem; margin-bottom: 10px; font-family: 'JetBrains Mono';">
            <i class="fa-solid fa-bolt"></i> Method Demonstration
          </div>
          <div style="color: #94a3b8; font-size: 0.75rem; margin-bottom: 10px;">
            Call methods on the most recent object:
          </div>
          <button class="method-btn" onclick="demoMethod('display')">
            obj.display()
          </button>
          <button class="method-btn" onclick="demoMethod('getter')">
            obj.getField()
          </button>
          <button class="method-btn" onclick="demoMethod('setter')">
            obj.setField(value)
          </button>
          <div class="method-output" id="methodOutput">
            // Output appears here...
          </div>
        </div>
      </div>

      <!-- RIGHT: THE HEAP (MEMORY) -->
      <div class="panel">
        <div class="panel-header">
          <i class="fa-solid fa-memory"></i> Heap Memory
        </div>

        <!-- Statistics Panel -->
        <div class="stats-panel">
          <div class="stat-item">
            <span class="stat-value" id="objectCount">0</span>
            <span class="stat-label">Objects in Memory</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="totalCreated">0</span>
            <span class="stat-label">Total Created</span>
          </div>
        </div>

        <div class="heap-grid" id="heap">
          <!-- Objects will appear here -->
        </div>

        <button class="clear-heap-btn" onclick="garbageCollectAll()" id="clearHeapBtn" style="display: none;">
          <i class="fa-solid fa-trash"></i> Garbage Collect All
        </button>

        <div
          style="
            margin-top: 10px;
            text-align: center;
            color: #64748b;
            font-size: 0.8rem;
            padding-top: 10px;
          "
        >
          Objects persist here until garbage collected.
        </div>
      </div>
    </div>

    <div class="explanation-box">
      <div>
        <h3 style="color: var(--accent); margin-top: 0">
          1. Design Phase (Left)
        </h3>
        <p>
          Select a template (Robot, Car, etc.) or create your own structure by
          adding fields. Notice how the <strong>Blueprint Code</strong> updates
          automatically. This represents writing the `.java` file.
        </p>
        <p style="font-size: 0.85rem; margin-top: 10px;">
          <strong>Try:</strong> Add static fields, remove fields, or try the Dog class to see inheritance!
        </p>
      </div>
      <div>
        <h3 style="color: var(--accent); margin-top: 0">
          2. Runtime Phase (Middle/Right)
        </h3>
        <p>
          When you click <code>new</code>, the JVM reads the current blueprint
          and allocates memory on the Heap. Try adding a field like
          <code>int ammo</code> to the Robot, and see how the created object
          changes!
        </p>
        <p style="font-size: 0.85rem; margin-top: 10px;">
          <strong>Key Concepts:</strong> Each object is independent. Static fields are shared across all instances. Delete objects to simulate garbage collection!
        </p>
      </div>
    </div>

    <!-- Main.java Usage Example -->
    <div class="explanation-box" style="max-width: 100%;">
      <div style="flex: 1;">
        <h3 style="color: var(--accent); margin-top: 0; display: flex; align-items: center; gap: 8px;">
          <i class="fa-solid fa-play"></i> 3. Using Your Class (Main.java)
        </h3>
        <p>
          In Java, you typically use your classes from a separate <code>Main.java</code> file with a <code>main</code> method.
          This is the entry point of your program where you create objects and call their methods.
        </p>
        <p style="font-size: 0.85rem; margin-top: 10px;">
          <strong>Note:</strong> The code below shows how to instantiate objects, access static fields, and call methods from your class blueprint.
        </p>
      </div>
      <div id="mainMethodDisplay" class="blueprint-content" style="max-height: 400px; font-size: 0.85rem; flex: 1.5;">
        <!-- Main method code injected by JS -->
      </div>
    </div>

    <!-- Animation Element -->
    <div id="beam" class="construction-beam"></div>

    <script>
      // --- DATA & STATE ---
      const icons = {
        Robot: "fa-robot",
        Car: "fa-car",
        Cat: "fa-cat",
        Planet: "fa-earth-americas",
        Dog: "fa-dog",
        Student: "fa-user-graduate",
      };

      // Initial State for different classes
      const classTemplates = {
        Robot: [
          { name: "name", type: "String", value: "Bender", isStatic: false },
          { name: "material", type: "String", value: "Metal", isStatic: false },
        ],
        Car: [
          { name: "brand", type: "String", value: "Tesla", isStatic: false },
          { name: "speed", type: "int", value: "120", isStatic: false },
        ],
        Cat: [
          { name: "name", type: "String", value: "Luna", isStatic: false },
          { name: "isHungry", type: "boolean", value: "true", isStatic: false },
        ],
        Planet: [
          { name: "name", type: "String", value: "Mars", isStatic: false },
          { name: "population", type: "int", value: "0", isStatic: false },
        ],
        Dog: [
          { name: "species", type: "String", value: "Canine", isStatic: true },
          { name: "name", type: "String", value: "Buddy", isStatic: false },
          { name: "breed", type: "String", value: "Golden Retriever", isStatic: false },
        ],
        Student: [
          { name: "name", type: "String", value: "Alice", isStatic: false },
          { name: "studentId", type: "int", value: "12345", isStatic: false },
          { name: "gpa", type: "double", value: "3.8", isStatic: false },
        ],
      };

      const classParents = {
        Dog: "Animal",
      };

      let currentClassName = "Robot";
      // Deep copy to allow modification without breaking defaults
      let currentFields = JSON.parse(JSON.stringify(classTemplates["Robot"]));
      let memoryCounter = 1000;
      let totalObjectsCreated = 0;
      let objectsInMemory = 0;
      let staticFieldValues = {}; // Shared across all instances

      // --- RENDER FUNCTIONS ---

      function renderBlueprint() {
        const codeDisplay = document.getElementById("codeDisplay");

        let staticFields = currentFields.filter(f => f.isStatic);
        let instanceFields = currentFields.filter(f => !f.isStatic);

        let staticFieldsHtml = staticFields
          .map(
            (f) =>
              `&nbsp;&nbsp;<span class="hl-key">public static</span> <span class="hl-type">${f.type}</span> <span class="hl-var">${f.name}</span> = <span class="hl-str">${f.type === 'String' ? '"' + f.value + '"' : f.value}</span>;`
          )
          .join("<br>");

        let fieldsHtml = instanceFields
          .map(
            (f) =>
              `&nbsp;&nbsp;<span class="hl-key">public</span> <span class="hl-type">${f.type}</span> <span class="hl-var">${f.name}</span>;`
          )
          .join("<br>");

        let paramsHtml = instanceFields
          .map(
            (f) =>
              `<span class="hl-type">${f.type}</span> ${f.name.substring(0, 1)}`
          )
          .join(", ");

        let constructorBodyHtml = instanceFields
          .map(
            (f) =>
              `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-key">this</span>.${
                f.name
              } = ${f.name.substring(0, 1)};`
          )
          .join("<br>");

        const extendsClause = classParents[currentClassName]
          ? ` <span class="hl-key">extends</span> <span class="hl-type">${classParents[currentClassName]}</span>`
          : '';

        let code = `
<span class="hl-key">public class</span> <span class="hl-type">${currentClassName}</span>${extendsClause} {<br>`;

        if (staticFields.length > 0) {
          code += `<span class="hl-comment">// Static Fields (Shared)</span><br>${staticFieldsHtml}<br><br>`;
        }

        if (instanceFields.length > 0) {
          code += `<span class="hl-comment">// Instance Fields</span><br>${fieldsHtml}<br><br>`;
        }

        code += `<span class="hl-comment">// Constructor</span><br>
&nbsp;&nbsp;<span class="hl-key">public</span> <span class="hl-type">${currentClassName}</span>(${paramsHtml}) {<br>`;

        if (constructorBodyHtml) {
          code += `${constructorBodyHtml}<br>`;
        }

        code += `&nbsp;&nbsp;}<br>`;

        // Add getter and setter methods for instance fields
        if (instanceFields.length > 0) {
          code += `<br><span class="hl-comment">// Getters & Setters</span><br>`;

          instanceFields.forEach(f => {
            const capitalizedName = f.name.charAt(0).toUpperCase() + f.name.slice(1);

            // Getter
            code += `&nbsp;&nbsp;<span class="hl-key">public</span> <span class="hl-type">${f.type}</span> get${capitalizedName}() {<br>`;
            code += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-key">return</span> <span class="hl-key">this</span>.${f.name};<br>`;
            code += `&nbsp;&nbsp;}<br>`;

            // Setter
            code += `&nbsp;&nbsp;<span class="hl-key">public void</span> set${capitalizedName}(<span class="hl-type">${f.type}</span> ${f.name}) {<br>`;
            code += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-key">this</span>.${f.name} = ${f.name};<br>`;
            code += `&nbsp;&nbsp;}<br>`;
          });

          // Add a display method
          code += `<br><span class="hl-comment">// Display Method</span><br>`;
          code += `&nbsp;&nbsp;<span class="hl-key">public void</span> display() {<br>`;
          code += `&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="hl-str">"=== ${currentClassName} Info ==="</span>);<br>`;

          instanceFields.forEach(f => {
            code += `&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="hl-str">"${f.name}: "</span> + <span class="hl-key">this</span>.${f.name});<br>`;
          });

          code += `&nbsp;&nbsp;}<br>`;
        }

        code += `}`;
        codeDisplay.innerHTML = code;
        renderFieldList();
        renderMainMethod();
      }

      function renderMainMethod() {
        const mainDisplay = document.getElementById("mainMethodDisplay");
        const instanceFields = currentFields.filter(f => !f.isStatic);
        const staticFields = currentFields.filter(f => f.isStatic);

        // Generate constructor arguments
        const constructorArgs = instanceFields.map(f => {
          if (f.type === "String") return `"${f.value}"`;
          return f.value;
        }).join(", ");

        let mainCode = `<span class="hl-key">public class</span> <span class="hl-type">Main</span> {<br>`;
        mainCode += `&nbsp;&nbsp;<span class="hl-key">public static void</span> main(<span class="hl-type">String</span>[] args) {<br>`;
        mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-comment">// Create a ${currentClassName} object</span><br>`;
        mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-type">${currentClassName}</span> obj = <span class="hl-key">new</span> <span class="hl-type">${currentClassName}</span>(${constructorArgs});<br><br>`;

        if (staticFields.length > 0) {
          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-comment">// Access static field</span><br>`;
          const firstStatic = staticFields[0];
          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="hl-type">${currentClassName}</span>.${firstStatic.name});<br><br>`;
        }

        if (instanceFields.length > 0) {
          const firstField = instanceFields[0];
          const capitalizedName = firstField.name.charAt(0).toUpperCase() + firstField.name.slice(1);

          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-comment">// Use getter method</span><br>`;
          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-type">${firstField.type}</span> value = obj.get${capitalizedName}();<br>`;
          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="hl-str">"${firstField.name}: "</span> + value);<br><br>`;

          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-comment">// Use setter method</span><br>`;
          const newValue = firstField.type === "String" ? '"NewValue"' : (firstField.type === "boolean" ? "false" : "100");
          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;obj.set${capitalizedName}(${newValue});<br><br>`;

          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="hl-comment">// Call display method</span><br>`;
          mainCode += `&nbsp;&nbsp;&nbsp;&nbsp;obj.display();<br>`;
        }

        mainCode += `&nbsp;&nbsp;}<br>}`;
        mainDisplay.innerHTML = mainCode;
      }

      function renderFieldList() {
        const fieldList = document.getElementById("fieldList");

        if (currentFields.length === 0) {
          fieldList.innerHTML = '<div style="color: #64748b; font-size: 0.8rem; padding: 8px; text-align: center;">No fields defined</div>';
          return;
        }

        fieldList.innerHTML = currentFields
          .map((f, idx) => {
            const isTemplate = classTemplates[currentClassName] &&
                             classTemplates[currentClassName].some(tf => tf.name === f.name);
            return `
              <div class="field-item ${isTemplate ? 'field-item-locked' : ''}">
                <span>
                  <span class="hl-type">${f.type}</span>
                  <span class="hl-var">${f.name}</span>
                  ${f.isStatic ? '<span class="static-badge">static</span>' : ''}
                </span>
                ${!isTemplate ? `<button class="delete-btn" onclick="removeField(${idx})"><i class="fa-solid fa-xmark"></i></button>` : '<span style="color: #64748b; font-size: 0.7rem;">template</span>'}
              </div>
            `;
          })
          .join("");
      }

      function renderInputs() {
        const container = document.getElementById("dynamicInputs");
        container.innerHTML = "";

        // Only show non-static fields in constructor
        const instanceFields = currentFields.filter(f => !f.isStatic);

        instanceFields.forEach((field, index) => {
          const actualIndex = currentFields.indexOf(field);
          const group = document.createElement("div");
          group.className = "input-group";

          let inputHtml = "";
          if (field.type === "boolean") {
            inputHtml = `
                        <select id="input-${actualIndex}" onchange="updatePreview()">
                            <option value="true" ${
                              field.value === "true" ? "selected" : ""
                            }>true</option>
                            <option value="false" ${
                              field.value === "false" ? "selected" : ""
                            }>false</option>
                        </select>
                    `;
          } else {
            const inputType = (field.type === "int" || field.type === "double") ? "number" : "text";
            const step = field.type === "double" ? "0.1" : "1";
            inputHtml = `<input type="${inputType}" step="${step}" id="input-${actualIndex}" value="${field.value}" oninput="updatePreview()">`;
          }

          group.innerHTML = `
                    <label>
                        <span>${field.name}</span>
                        <span class="type-badge">${field.type}</span>
                    </label>
                    ${inputHtml}
                `;
          container.appendChild(group);
        });

        document.getElementById(
          "btnText"
        ).innerText = `new ${currentClassName}();`;
        updatePreview();
      }

      function updatePreview() {
        // Read values from current inputs (only instance fields)
        const instanceFields = currentFields.filter(f => !f.isStatic);
        const values = instanceFields.map((f, i) => {
          const actualIndex = currentFields.indexOf(f);
          const el = document.getElementById(`input-${actualIndex}`);
          if (!el) return "...";
          if (f.type === "String") return `"${el.value}"`;
          return el.value;
        });

        const prev = document.getElementById("code-preview");
        prev.innerHTML = `${currentClassName} obj = <span class="hl-key">new</span> ${currentClassName}(<span class="hl-str">${values.join(
          ", "
        )}</span>);`;
      }

      function updateStats() {
        document.getElementById("objectCount").textContent = objectsInMemory;
        document.getElementById("totalCreated").textContent = totalObjectsCreated;

        const clearBtn = document.getElementById("clearHeapBtn");
        clearBtn.style.display = objectsInMemory > 0 ? "block" : "none";
      }

      // --- ACTIONS ---

      function switchClass() {
        const sel = document.getElementById("classSelector");
        currentClassName = sel.value;
        // Reset to template default when switching (optional, but cleaner)
        currentFields = JSON.parse(
          JSON.stringify(classTemplates[currentClassName])
        );

        renderBlueprint();
        renderInputs();
      }

      function validateFieldName(name) {
        // Java naming conventions
        if (!name || name.length === 0) return "Field name cannot be empty";
        if (!/^[a-zA-Z_$]/.test(name)) return "Field name must start with a letter, underscore, or dollar sign";
        if (!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(name)) return "Field name can only contain letters, digits, underscores, and dollar signs";
        if (/^[A-Z]/.test(name)) return "Field names should start with a lowercase letter (convention)";
        const javaKeywords = ["class", "public", "private", "static", "void", "int", "boolean", "if", "else", "for", "while", "return", "new", "this"];
        if (javaKeywords.includes(name)) return "Cannot use Java keyword as field name";
        if (currentFields.some((f) => f.name === name)) return "Field name already exists";
        return null;
      }

      function addField() {
        const nameInput = document.getElementById("newFieldName");
        const typeInput = document.getElementById("newFieldType");

        const name = nameInput.value.trim();
        const type = typeInput.value;

        const validationError = validateFieldName(name);
        if (validationError) {
          alert(validationError);
          return;
        }

        // Default values for new fields
        let defVal = "val";
        if (type === "int") defVal = "0";
        if (type === "boolean") defVal = "true";
        if (type === "double") defVal = "0.0";

        currentFields.push({ name, type, value: defVal, isStatic: false });

        nameInput.value = ""; // clear
        renderBlueprint();
        renderInputs();
      }

      function addStaticField() {
        const nameInput = document.getElementById("newFieldName");
        const typeInput = document.getElementById("newFieldType");

        const name = nameInput.value.trim();
        const type = typeInput.value;

        const validationError = validateFieldName(name);
        if (validationError) {
          alert(validationError);
          return;
        }

        // Default values for new fields
        let defVal = "val";
        if (type === "int") defVal = "0";
        if (type === "boolean") defVal = "true";
        if (type === "double") defVal = "0.0";

        currentFields.push({ name, type, value: defVal, isStatic: true });
        staticFieldValues[currentClassName + "." + name] = defVal;

        nameInput.value = ""; // clear
        renderBlueprint();
        renderInputs();
      }

      function removeField(index) {
        const field = currentFields[index];
        if (field.isStatic) {
          delete staticFieldValues[currentClassName + "." + field.name];
        }
        currentFields.splice(index, 1);
        renderBlueprint();
        renderInputs();
      }

      function resetClass() {
        if (confirm("Reset class to template? This will remove all custom fields.")) {
          currentFields = JSON.parse(
            JSON.stringify(classTemplates[currentClassName])
          );
          renderBlueprint();
          renderInputs();
        }
      }

      function createObject() {
        // Gather instance field data
        const instanceData = [];
        const staticData = [];

        currentFields.forEach((f, i) => {
          if (f.isStatic) {
            const key = currentClassName + "." + f.name;
            staticData.push({
              name: f.name,
              value: staticFieldValues[key] || f.value,
              type: f.type,
              isStatic: true
            });
          } else {
            // Use the actual index i which matches the input element ID
            const el = document.getElementById(`input-${i}`);
            if (el) {
              instanceData.push({ name: f.name, value: el.value, type: f.type, isStatic: false });
            }
          }
        });

        // Animation Setup
        const btn = document.querySelector(".btn-construct");
        const blueprint = document.getElementById("blueprint-panel");
        const heap = document.getElementById("heap");
        const beam = document.getElementById("beam");

        const startRect = blueprint.getBoundingClientRect();
        const endRect = heap.getBoundingClientRect();

        const startX = startRect.left + startRect.width / 2;
        const startY = startRect.top + startRect.height / 2;
        const endX = endRect.left + 150;
        const endY = endRect.top + 50; // Aim for top of heap

        // Play Animation
        beam.style.display = "block";
        beam.style.left = startX + "px";
        beam.style.top = startY + "px";

        const anim = beam.animate(
          [
            { left: startX + "px", top: startY + "px", transform: "scale(1)" },
            { left: endX + "px", top: endY + "px", transform: "scale(0.5)" },
          ],
          {
            duration: 600,
            easing: "cubic-bezier(0.4, 0, 0.2, 1)",
          }
        );

        anim.onfinish = () => {
          beam.style.display = "none";
          addObjectToHeap([...instanceData, ...staticData]);
        };
      }

      function addObjectToHeap(data) {
        const heap = document.getElementById("heap");
        const card = document.createElement("div");
        card.className = "object-card";

        const address = "0x" + memoryCounter.toString(16).toUpperCase();
        const objectId = totalObjectsCreated;
        memoryCounter += 8;
        totalObjectsCreated++;
        objectsInMemory++;

        card.setAttribute('data-object-id', objectId);
        card.setAttribute('data-class', currentClassName);

        const iconClass = icons[currentClassName] || "fa-cube";

        // Separate static and instance fields
        const instanceFields = data.filter(d => !d.isStatic);
        const staticFields = data.filter(d => d.isStatic);

        // Generate field list HTML
        const fieldsHtml = instanceFields
          .map((d) => {
            let valDisplay = d.value;
            if (d.type === "String") valDisplay = `"${d.value}"`;
            return `
                    <div class="field-row">
                        <span class="field-name">${d.name}:</span>
                        <span class="field-val">${valDisplay}</span>
                    </div>
                `;
          })
          .join("");

        const staticFieldsHtml = staticFields.length > 0 ? `
          <div style="border-top: 1px dashed #475569; margin-top: 8px; padding-top: 8px;">
            <div style="font-size: 0.65rem; color: #64748b; margin-bottom: 4px;">STATIC (shared):</div>
            ${staticFields.map(d => {
              let valDisplay = d.value;
              if (d.type === "String") valDisplay = `"${d.value}"`;
              return `
                <div class="field-row">
                  <span class="field-name">${d.name}:</span>
                  <span class="field-val">${valDisplay}</span>
                </div>
              `;
            }).join("")}
          </div>
        ` : '';

        const extendsInfo = classParents[currentClassName]
          ? `<span class="extends-badge">extends ${classParents[currentClassName]}</span>`
          : '';

        const isPrimitive = instanceFields.every(f => f.type !== "String");
        const refIndicator = !isPrimitive
          ? '<div class="reference-indicator">reference type</div>'
          : '';

        card.innerHTML = `
                <button class="delete-object-btn" onclick="garbageCollect(${objectId})">
                    <i class="fa-solid fa-trash"></i>
                </button>
                <div class="card-icon">
                    <i class="fa-solid ${iconClass}"></i>
                    <div style="font-size:0.6rem; margin-top:5px; color:#64748b;">${currentClassName} ${extendsInfo}</div>
                </div>
                <div class="card-details">
                    <span class="mem-address">${address}</span>
                    ${fieldsHtml}
                    ${staticFieldsHtml}
                </div>
                ${refIndicator}
            `;

        heap.prepend(card); // Add to top
        updateStats();
        checkMethodPanel();

        // Highlight briefly to show independence
        setTimeout(() => {
          card.classList.add('highlight');
          setTimeout(() => card.classList.remove('highlight'), 1000);
        }, 100);
      }

      function garbageCollect(objectId) {
        const card = document.querySelector(`[data-object-id="${objectId}"]`);
        if (card) {
          card.style.animation = 'none';
          card.style.transition = 'all 0.3s';
          card.style.opacity = '0';
          card.style.transform = 'scale(0.8)';

          setTimeout(() => {
            card.remove();
            objectsInMemory--;
            updateStats();
            checkMethodPanel();
          }, 300);
        }
      }

      function garbageCollectAll() {
        if (confirm(`Garbage collect all ${objectsInMemory} objects?`)) {
          const heap = document.getElementById("heap");
          const cards = heap.querySelectorAll('.object-card');

          cards.forEach((card, index) => {
            setTimeout(() => {
              card.style.transition = 'all 0.3s';
              card.style.opacity = '0';
              card.style.transform = 'scale(0.5)';
            }, index * 50);
          });

          setTimeout(() => {
            heap.innerHTML = '';
            objectsInMemory = 0;
            updateStats();
            checkMethodPanel();
          }, cards.length * 50 + 300);
        }
      }

      function checkMethodPanel() {
        const methodPanel = document.getElementById('methodPanel');
        if (objectsInMemory > 0) {
          methodPanel.style.display = 'block';
        } else {
          methodPanel.style.display = 'none';
        }
      }

      function demoMethod(methodType) {
        const heap = document.getElementById('heap');
        const cards = heap.querySelectorAll('.object-card');
        const output = document.getElementById('methodOutput');

        if (cards.length === 0) {
          output.innerHTML = '// Error: No objects in memory!';
          return;
        }

        // Get the first (most recent) object
        const firstCard = cards[0];
        const className = firstCard.getAttribute('data-class');

        // Get only instance fields (not static)
        const cardDetails = firstCard.querySelector('.card-details');
        const instanceFieldRows = Array.from(cardDetails.querySelectorAll('.field-row')).filter(row => {
          return !row.closest('[style*="border-top"]');
        });

        if (methodType === 'display') {
          // Simulate the display() method from the blueprint
          let info = `// Calling: obj.display();\n\n`;
          info += `=== ${className} Info ===\n`;

          instanceFieldRows.forEach(row => {
            const fieldName = row.querySelector('.field-name').textContent.replace(':', '');
            const value = row.querySelector('.field-val').textContent;
            info += `${fieldName}: ${value}\n`;
          });

          output.innerHTML = info;

          // Highlight the object
          firstCard.classList.add('highlight');
          setTimeout(() => firstCard.classList.remove('highlight'), 2000);

        } else if (methodType === 'getter') {
          // Simulate a getter method
          const firstField = instanceFieldRows[0];
          if (firstField) {
            const fieldName = firstField.querySelector('.field-name').textContent.replace(':', '');
            const value = firstField.querySelector('.field-val').textContent;
            const capitalizedName = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);

            let info = `// Calling: obj.get${capitalizedName}();\n\n`;
            info += `// Returns: ${value}`;
            output.innerHTML = info;

            // Highlight the object
            firstCard.classList.add('highlight');
            setTimeout(() => firstCard.classList.remove('highlight'), 2000);
          }

        } else if (methodType === 'setter') {
          // Simulate a setter method
          const firstField = instanceFieldRows[0];
          if (firstField) {
            const fieldName = firstField.querySelector('.field-name').textContent.replace(':', '');
            const fieldValEl = firstField.querySelector('.field-val');
            const oldValue = fieldValEl.textContent;
            const capitalizedName = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);

            // Generate new value based on type
            let newValue;
            if (oldValue.includes('"')) {
              newValue = `"Updated_${Date.now() % 1000}"`;
            } else if (oldValue === 'true' || oldValue === 'false') {
              newValue = oldValue === 'true' ? 'false' : 'true';
            } else {
              // Handle numeric values
              const numValue = parseFloat(oldValue);
              if (!isNaN(numValue)) {
                newValue = oldValue.includes('.') ? (numValue + 0.1).toFixed(1) : (numValue + 1).toString();
              } else {
                newValue = '0';
              }
            }

            fieldValEl.textContent = newValue;

            let info = `// Calling: obj.set${capitalizedName}(${newValue});\n\n`;
            info += `// Field "${fieldName}" updated:\n`;
            info += `// ${oldValue} â†’ ${newValue}`;
            output.innerHTML = info;

            // Highlight the object with animation
            firstCard.classList.add('highlight');
            setTimeout(() => firstCard.classList.remove('highlight'), 2000);
          }
        }
      }

      // Init
      renderBlueprint();
      renderInputs();
      updateStats();
      checkMethodPanel();
    </script>
  </body>
</html>
